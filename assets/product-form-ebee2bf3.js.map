{"version":3,"file":"product-form-ebee2bf3.js","sources":["../src/scripts/product/product-form.ts"],"sourcesContent":["import { PUB_SUB_EVENTS } from '@/scripts/theme/constants'\nimport { addToCartConfig, closestOptional, qsOptional, qsRequired } from '@/scripts/functions'\nimport { type CartNotification } from '@/scripts/theme/cart-notification'\nimport { type CartDrawer } from '@/scripts/cart-drawer/cart-drawer'\nimport { routes, type uCoastWindow } from '@/scripts/setup'\nimport { publish } from '@/scripts/theme/pubsub'\nimport { QuickAddModal } from '@/scripts/optional/quick-add'\nimport { UcoastEl } from '@/scripts/core/UcoastEl'\n\ndeclare let window: uCoastWindow\n\nexport class ProductForm extends UcoastEl {\n\tstatic htmlSelector = 'product-form'\n\tform: HTMLFormElement\n\tformIdEl: HTMLInputElement\n\tcart?: CartNotification | CartDrawer\n\tsubmitButton: HTMLButtonElement\n\terrorMessageWrapper?: HTMLElement\n\terrorMessage?: HTMLElement\n\thideErrors: boolean\n\terror?: boolean\n\n\tconstructor() {\n\t\tsuper()\n\n\t\tthis.form = qsRequired('form', this)\n\t\tthis.formIdEl = qsRequired('[name=id]', this.form)\n\t\tthis.formIdEl.disabled = false\n\t\tthis.form.addEventListener('submit', this.onSubmitHandler.bind(this))\n\t\tthis.cart =\n\t\t\tqsOptional<CartNotification>('cart-notification') ||\n\t\t\tqsOptional<CartDrawer>('cart-drawer')\n\t\tthis.submitButton = qsRequired('[type=\"submit\"]', this)\n\t\tif (this.cart && this.cart.localName === 'cart-drawer')\n\t\t\tthis.submitButton.setAttribute('aria-haspopup', 'dialog')\n\n\t\tthis.hideErrors = this.dataset.hideErrors === 'true'\n\t}\n\n\tgetSpinner() {\n\t\treturn qsRequired('.loading-overlay__spinner', this)\n\t}\n\n\tonSubmitHandler(event: Event) {\n\t\tevent.preventDefault()\n\t\tif (this.submitButton.getAttribute('aria-disabled') === 'true') return\n\n\t\tthis.handleErrorMessage()\n\n\t\tthis.submitButton.setAttribute('aria-disabled', 'true')\n\t\tthis.submitButton.classList.add('loading')\n\t\tthis.getSpinner().classList.remove('hidden')\n\n\t\tconst formData = new FormData(this.form)\n    console.log('this.form', this.form)\n    console.log({formData: JSON.stringify(formData)})\n\t\tif (this.cart) {\n\t\t\tconst sectionIdsToRender = this.cart\n\t\t\t\t.getSectionsToRender()\n\t\t\t\t.filter((section) => section.id)\n\t\t\t\t.map((section) => section.id)\n\t\t\tif (!sectionIdsToRender.length) throw Error('getSectionsToRender returned empty array')\n\t\t\tformData.append('sections', sectionIdsToRender.join(','))\n\t\t\tformData.append('sections_url', window.location.pathname)\n\t\t\tif (!(document.activeElement instanceof HTMLElement)) throw Error('no activeElement')\n\t\t\tthis.cart.setActiveElement(document.activeElement)\n\t\t}\n\t\tconst config = addToCartConfig(formData)\n\t\tconst addedVariantId = formData.get('id') as string\n    console.log({config, url: `${routes.cart_add_url}`})\n\t\tif (!addedVariantId) throw Error('No variant id found')\n\n\t\tfetch(`${routes.cart_add_url}`, config)\n\t\t\t.then((response) => response.json())\n\t\t\t.then((response) => {\n\t\t\t\tif (response.status) {\n\t\t\t\t\tpublish(PUB_SUB_EVENTS.cartError, {\n\t\t\t\t\t\tsource: 'product-form',\n\t\t\t\t\t\tproductVariantId: addedVariantId,\n\t\t\t\t\t\terrors: response.errors || response.description,\n\t\t\t\t\t\tmessage: response.message,\n\t\t\t\t\t})\n\t\t\t\t\tthis.handleErrorMessage(response.description)\n\n\t\t\t\t\tconst soldOutMessage = this.submitButton.querySelector('.sold-out-message')\n\t\t\t\t\tif (!soldOutMessage) return\n\t\t\t\t\tthis.submitButton.setAttribute('aria-disabled', 'true')\n\t\t\t\t\tconst submitButtonText = qsRequired('span', this.submitButton)\n\t\t\t\t\tsubmitButtonText.classList.add('hidden')\n\t\t\t\t\tsoldOutMessage.classList.remove('hidden')\n\t\t\t\t\tthis.error = true\n\t\t\t\t\treturn\n\t\t\t\t} else if (!this.cart) {\n\t\t\t\t\twindow.location = window.routes.cart_url\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tif (!this.error)\n\t\t\t\t\tpublish(PUB_SUB_EVENTS.cartUpdate, {\n\t\t\t\t\t\tsource: 'product-form',\n\t\t\t\t\t\tproductVariantId: addedVariantId,\n\t\t\t\t\t})\n\t\t\t\tthis.error = false\n\t\t\t\tconst quickAddModal = closestOptional<QuickAddModal>(this, 'quick-add-modal')\n\t\t\t\tif (quickAddModal) {\n\t\t\t\t\tdocument.body.addEventListener(\n\t\t\t\t\t\t'modalClosed',\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\tif (this.cart) {\n\t\t\t\t\t\t\t\t\tthis.cart.renderContents(response)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{ once: true }\n\t\t\t\t\t)\n\t\t\t\t\tquickAddModal.hide(true)\n\t\t\t\t} else {\n\t\t\t\t\tthis.cart.renderContents(response)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch((e) => {\n\t\t\t\tconsole.error(e)\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tthis.submitButton.classList.remove('loading')\n\t\t\t\tif (this.cart && this.cart.classList.contains('is-empty'))\n\t\t\t\t\tthis.cart.classList.remove('is-empty')\n\t\t\t\tif (!this.error) this.submitButton.removeAttribute('aria-disabled')\n\t\t\t\tthis.getSpinner().classList.add('hidden')\n\t\t\t})\n\t}\n\n\thandleErrorMessage(errorMessage?: string) {\n\t\tif (this.hideErrors) return\n\n\t\tthis.errorMessageWrapper =\n\t\t\tthis.errorMessageWrapper || qsRequired('.product-form__error-message-wrapper', this)\n\t\tif (!this.errorMessageWrapper) throw new Error('No error message wrapper found')\n\t\tthis.errorMessage =\n\t\t\tthis.errorMessage ||\n\t\t\tqsRequired('.product-form__error-message', this.errorMessageWrapper)\n\n\t\tthis.errorMessageWrapper.toggleAttribute('hidden', !errorMessage)\n\n\t\tif (errorMessage) {\n\t\t\tthis.errorMessage.textContent = errorMessage\n\t\t}\n\t}\n}\n"],"names":["ProductForm","UcoastEl","qsRequired","qsOptional","event","formData","sectionIdsToRender","section","config","addToCartConfig","addedVariantId","routes","response","publish","PUB_SUB_EVENTS","soldOutMessage","quickAddModal","closestOptional","e","errorMessage"],"mappings":"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"}